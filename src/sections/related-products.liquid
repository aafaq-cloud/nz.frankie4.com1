{% comment %}
Custom logic to get related products.
Related products are any product that shares one or more collections with the current product.
The section has an option to exclude collections. This is useful for excluding general collections
such as 'featured' or 'all'.
{% endcomment %}

{% assign excluded_collections = section.settings.exclude_collections | split: "," %}
{% assign related_collections = '' %}

{% for collection in product.collections %}
    {% unless excluded_collections contains collection.handle %}
        {% if related_collections != '' %}
            {% assign related_collections = related_collections | append: ',' %}
        {% endif %}
        {% assign related_collections = related_collections | append: collection.handle %}
    {% endunless %}
{% endfor %}
{% assign related_collections = related_collections | split: "," %}

{% assign related_products_count = 0 %}
{% assign related_products = '' %}

{% for related_collection in related_collections %}
	{% for looped_product in collections[related_collection].products %}

		{% unless related_products_count > 9 %}
			{% if looped_product.handle == product.handle %}
				{% continue %}
			{% endif %}
			{% if related_products != '' %}
				{% assign related_products = related_products | append: ',' %}
			{% endif %}
            {% assign related_products = related_products | append: looped_product.handle %}
            {% assign related_products_count = related_products_count | plus: 1 %}

		{% endunless %}
	{% endfor %}
{% endfor %}

{% assign related_products = related_products | split: "," %}

{% if related_products.size > 0 %}
    <div class="section section-related-products large-margin">

         <div class="grid-container related-products-container">

             <div class="title-block medium-text-center">
                <h2 class="h1 m-0">{{section.settings.section_title}}</h2>
                 {% if section.settings.section_subheading != blank %}
                     <p class="lead color-secondary-text mt-5 mb-0">{{section.settings.section_subheading}}</p>
                 {% endif %}
            </div>

            <div class="grid-x grid-margin-x">
                <div data-autoload-class="ComponentCarousel" class="carousel cell mt-30">
                    <div class="glide">
                        <div data-glide-el="track" class="glide__track">
                          <div class="glide__slides">
                           {% for related_product_handle in related_products %}
                                {%- assign product = all_products[related_product_handle] -%}
                                <div class="glide__slide">
                                      {% include 'product-tile' %}
                                </div>
                           {% endfor %}
                          </div>
                        </div>
                        <div class="glide__arrows" data-glide-el="controls">
                          <button class="glide__arrow glide__arrow--left" data-glide-dir="<">{% include "icon-chevron" %}</button>
                          <button class="glide__arrow glide__arrow--right" data-glide-dir=">">{% include "icon-chevron" %}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% schema %}

{
    "name": "Related Products",
    "settings": [
        {
            "type": "header",
            "content": "Section Title"
        },
        {
            "type": "text",
            "id": "section_title",
            "label": "Title"
        },
        {
            "type": "text",
            "id": "section_subheading",
            "label": "Subheading"
        },
        {
            "type": "text",
            "id": "exclude_collections",
            "label": "Exclude Collections",
            "info": "Add comma separated list of collection handles to exclude from related products."
        }
    ]
}

{% endschema %}
